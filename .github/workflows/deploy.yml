name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies (Migrator)
        run: npm ci
        
      - name: üóÑÔ∏è Aplicar Migraciones de DB (desde GitHub)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy

      - name: üöÄ Deploy a VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 30m
          script: |
            set -e
            echo "üöÄ Iniciando deploy en VPS..."
            cd /var/www/plataforma-servicios-ceres
            
            # Detectar IP del host
            DOCKER_GATEWAY_IP=$(docker network inspect bridge --format '{{range .IPAM.Config}}{{.Gateway}}{{end}}' 2>/dev/null || echo "172.17.0.1")
            
            # Pull y Backup
            git fetch origin main && git reset --hard origin/main
            [ -f .env ] && cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            
            # Funci√≥n para actualizar variables
            update_env_var() {
              local key=$1
              local value=$2
              grep -q "^${key}=" .env && sed -i "s|^${key}=.*|${key}=${value}|" .env || echo "${key}=${value}" >> .env
            }
            
            # Actualizar .env (mantenemos esto para el runtime de la app)
            echo "üìù Actualizando .env..."
            update_env_var "DATABASE_URL" "${{ secrets.DATABASE_URL }}"
            update_env_var "NEXT_PUBLIC_BASE_URL" "${{ secrets.NEXT_PUBLIC_BASE_URL }}"
            update_env_var "NEXTAUTH_URL" "${{ secrets.NEXTAUTH_URL }}"
            update_env_var "NEXTAUTH_SECRET" "${{ secrets.NEXTAUTH_SECRET }}"
            update_env_var "NODE_ENV" "production"
            
            # üõ†Ô∏è CORRECCI√ìN DE RED (solo para el runtime de la app)
            sed -i "s|localhost:5432|${DOCKER_GATEWAY_IP}:5432|g" .env
            sed -i "s|127.0.0.1:5432|${DOCKER_GATEWAY_IP}:5432|g" .env
            
            # Aislamiento de proyecto
            export COMPOSE_PROJECT_NAME=ceres
            
            # Detectar qu√© versi√≥n de docker-compose usar
            if docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            elif command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
            else
              echo "‚ùå Error: Docker Compose no est√° instalado"
              exit 1
            fi
            echo "üê≥ Usando: $COMPOSE_CMD"

            # Limpiar y Construir
            sudo docker image prune -f
            echo "üî® Construyendo imagen..."
            sudo $COMPOSE_CMD build --no-cache \
              --build-arg NEXT_PUBLIC_BASE_URL="${{ secrets.NEXT_PUBLIC_BASE_URL }}" \
              --build-arg NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}" \
              --build-arg DATABASE_URL="${{ secrets.DATABASE_URL }}" app
            
            echo "üöÄ Levantando App..."
            sudo $COMPOSE_CMD up -d --remove-orphans app
            
            echo "‚úÖ ¬°Deploy Exitoso! La DB fue actualizada por GitHub y la App por el VPS."